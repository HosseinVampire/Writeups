from PIL import Image
import pytesseract
import requests
from bs4 import BeautifulSoup
from io import StringIO
def solve(captcha):
    return pytesseract.image_to_string(captcha,config=r'--oem 3 --psm 6')[::-1]

def postSolution():
    with requests.session() as s :
        auth='https://defendtheweb.net/auth'
        creds={'username':'hosein','password':'Xx164325897'}
        login=s.post(auth , data=creds)
        ctfurl='https://defendtheweb.net/playground/captcha1'
        captcha = s.get('https://defendtheweb.net/extras/playground/captcha/captcha1.php')
        captcha = open('captcha1.png','wb').write(captcha.content)
        solution=solve('captcha1.png')
        solution2=''           
        for i in solution:
            if i == ' ':
                pass
            else:
                solution2 += i
        get_csrf=s.get(ctfurl)
        soup=BeautifulSoup(get_csrf.text ,'html.parser')
        csrf=soup.find('input',attrs={'name':'token'})['value']
        data={'token':csrf,'answer':solution2}
        answer=s.post(ctfurl,data=data)
        res=answer.text
        if  'Invalid' in res :
            return "WRONG"
        else:
            return "[!] HACKED"
count = 0
postSolution()
while postSolution() == "WRONG":
    count +=1
    print(f'Attempt number: {count}')
    postSolution()
print("HACKED")